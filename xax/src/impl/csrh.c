#include <stdio.h>
#include <unistd.h>
#include "args.h"
#include "proc.h"
#include "util.h"
#include "scan.h"
#include "impl.h"
#include "hashtable.h"
#include <math.h>
#include <pthread.h>

#define BLOCKS 256

static const int OFFSET_X = 66;
static int SAMPLE_PATTERN_X[] =
  {128, 63, 2, -1, 3, 128, -1, -1, -1, -1, 13,

  };

static const int OFFSET_ANG = 1162;
static int SAMPLE_PATTERN_ANG[] =
  {128, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 63, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 63, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 68, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 68, -1, -1, -1, 45, -1, -1, -1, 164, 1,
   -1, -1, 45, -1, -1, -1, 4, 3, -1, -1, 8, -1, -1, -1, -1, -1, -1, -1, 56, 3, -1, -1, 8, -1, -1, -1, -1, -1, -1, -1,
   12, 3, -1, -1, 8, -1, -1, -1, -1, -1, -1, -1, 64, 3, -1, -1, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, 128, 191, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1,
   128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1,
   128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1,
   -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1,
   -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191,
   -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1,
   -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128,
   191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1,
   -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1,
   128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1,
   -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1,
   -1, 128, 191, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1,
   -1, -1, -1, -1, -1, 128, 191, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1,
   -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, 1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1,
   -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191,
   -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1,
   -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128,
   191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1,
   -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1,
   128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1,
   -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1,
   -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191,
   -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1,
   -1, -1, 128, 191, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128, 191, -1, -1, -1, -1, -1, -1, 128, 191,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 63, 1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 44, -1,
   -1, -1, 22, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 44, -1, -1, -1, 22, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2,
   255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 2, -1, -1, -1, -1, -1, 128,
   63, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, 63, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 63, -1, -1, -1,
   -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255,
   255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255,
   255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 44, -1, -1, -1, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255,
   255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255,
   255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1,
   255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 44, -1,
   -1, -1, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128, 63, -1, -1, -1, -1, -1, -1,
   -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 44, -1, -1, -1, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255,
   255, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255,
   255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255,
   255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255,
   255, 255, 255, -1, -1, 44, -1, -1, -1, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255,
   255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255,
   255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128, 63, -1, -1, -1, -1, -1, -1, -1, -1,
   255, 255, 2, 255, -1, -1, 128, 63, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 44, -1, -1, -1, 7, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2,
   255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255,
   255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 44, -1, -1, -1, 7, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255,
   255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128,
   63, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2,
   255, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255,
   255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 44, -1, -1, -1, 4, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255,
   2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, 44, -1, -1, -1, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, 128, 63, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255,
   255, 2, 255, -1, -1, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 44, -1, -1,
   -1, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, 255, 255, 255, 255, 255, -1, -1,
   -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
   -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1,
   -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 44, -1, -1, -1, 4, -1, -1, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1,
   255, 255, 2, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255,
   255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 128, 63, -1, -1, -1, -1, -1, -1, -1,
   -1, 255, 255, 2, 255, -1, -1, 128, 63, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, -1, 255, 255,
   255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 44, -1, -1,
   -1, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, 255, 255, 255, 255, 255, -1, -1,
   -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 255, 255, 255,
   255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 255, 255, 255, 255, 255, 255, -1, -1, 44, -1, -1, -1, 2, -1, -1,
   -1, -1, -1, -1, -1, -1, -1, -1, -1, 255, 255, 2, 255, 255, 255, 255, 255, 255, 255, 255, 255, -1, -1, -1, -1, -1, -1,
   -1, -1, 255, 255, 2, 255, 255, 255, 255,
  };

static int OFFSET_Ps = -800;
static int SAMPLE_PATTERN_Ps[] = {97, -1, -1, 252, -1, -1, -1, -1, 208, -1, -1, -1, -1, -1, -1, -1, 64, 112, 18};

int matches(char *ptr, int *pattern, int len) {
  while (len > 0 && (*pattern == -1 || (uint8_t) * ptr == *pattern)) {
    len--;
    pattern++;
    ptr++;
  }
  return len == 0;
}

int is_div_by(double x, double y) {
  double r = x / y;
  return fabs(r - round(r)) < 10e-12;
}

pthread_mutex_t LOCK;
hashtable *MY_XS;
hashtable *MY_AS;

static int
try_set_addr(int mem_fd, char *bytes, int pattern[], size_t size, uintptr_t *addr, uintptr_t new_addr) {
  if (matches(bytes, pattern, size)) {
    float x = read_mem_word32(mem_fd, new_addr).float32;
    if (!is_div_by(x, 0.000250) && IN_RANGE(-5000, x, 5000) && !FLOAT_EQ(x, 0)) {
      *addr = new_addr;
      return 1;
    }
  }
  return 0;
}

static void *run_bg_scans(void *) {
  OPEN_MEM("cs2$");
  READ_DS(BLOCKS);
  mem_block *bs[BLOCKS];
  for (;;) {
    for (int i = 100; i < 160; i++) {
      mem_desc desc = ds[i];
      bs[i] = read_mem_block(fd, desc.start, desc.size);
      char *bytes = bs[i]->bytes;
      for (size_t j = 0; j < bs[i]->size; j++) {  // (!a_done || !x_done)
        uintptr_t ang_addr = desc.start + j + OFFSET_ANG;
        uintptr_t x_addr = desc.start + j + OFFSET_X;
        if (!hash_getv(MY_AS, KV(.uint64 = ang_addr)).uint64 &&
            matches(bytes + j, SAMPLE_PATTERN_ANG, SIZEARR(SAMPLE_PATTERN_ANG))) {
          hash_set(MY_AS, KV(.uint64 = ang_addr), KV(.uint64 = 0));
        }
        if (!hash_getv(MY_XS, KV(.uint64 = x_addr)).uint64 &&
            matches(bytes + j, SAMPLE_PATTERN_X, SIZEARR(SAMPLE_PATTERN_X))) {
          hash_set(MY_XS, KV(.uint64 = x_addr), KV(.uint64 = 0));
        }
      }
      free_mem(bs[i]);
    }
    sleep(15);
  }
}

static void *run_bg_output(void *) {
  OPEN_MEM("cs2$");
  for (;;) {
    size_t len = MY_XS->len;
    kv *x_keys = hash_keys(MY_XS);
    int output = 0;
    for (int i = 0; i < len; i++) {
      float prev = hash_getv(MY_AS, x_keys[i]).float32;
      float curr = read_mem_word32(fd, x_keys[i].uint64).float32;
      if (IN_RANGE(-5000, curr, 5000) && !FLOAT_EQ(curr, prev)) {
        float curr_y = read_mem_word32(fd, x_keys[i].uint64 + 4).float32;
        printf("(%f, %f)  ", curr, curr_y);
        hash_set(MY_AS, x_keys[i], KV(.float32 = curr));
        output = 1;
        break;
      }
    }
    len = MY_AS->len;
    kv *a_keys = hash_keys(MY_AS);
    for (int i = 0; i < len; i++) {
      float prev = hash_getv(MY_AS, a_keys[i]).float32;
      float curr = read_mem_word32(fd, a_keys[i].uint64).float32;
      if (IN_RANGE(-180, curr, 180) && !FLOAT_EQ(curr, prev)) {
        printf("%f", curr);
        hash_set(MY_AS, a_keys[i], KV(.float32 = curr));
        output = 1;
        break;
      }
    }
    output && puts("");
    usleep(100 * 1000);
  }
}

static void run(void) {
  MY_XS = hash_new(128, hash_int, hash_cmp_int);
  MY_AS = hash_new(128, hash_int, hash_cmp_int);
  pthread_t bg_scanner, bg_output;
  pthread_create(&bg_scanner, NULL, run_bg_scans, NULL);
  pthread_create(&bg_output, NULL, run_bg_output, NULL);
  pthread_join(bg_scanner, NULL);
  pthread_join(bg_output, NULL);
}


__attribute__((constructor))
static void init(void) {
  args_add("csrh", run);
}


static void run_old(void) {
  OPEN_MEM("cs2$");
  READ_DS(BLOCKS);
  size_t I = 0;
  mem_block *blocks[BLOCKS];
  for (int i = 30; i < 240; i++) {
    mem_desc *desc = ds + i;
    blocks[i] = read_mem_block(fd, desc->start, desc->size);
    char *bytes = blocks[i]->bytes;
    for (long j = 0; j < blocks[i]->size; j++) {
      if (matches(bytes + j, SAMPLE_PATTERN_ANG, SIZEARR(SAMPLE_PATTERN_ANG))) {
        union word32 ang;
        int first_byte = j + OFFSET_ANG;
        uintptr_t addr = desc->start + first_byte;
        read_mem_bytes(fd, addr, ang.bytes, 4);
        printf("ANGLE 0x%lx %d %f [%f]\n", addr, i, (double)first_byte / (double)desc->size, ang.float32);
      }
      if (matches(bytes + j, SAMPLE_PATTERN_Ps, SIZEARR(SAMPLE_PATTERN_Ps))) {
        union word32 x_pos;
        union word32 y_pos;

        uintptr_t addr = desc->start + j + OFFSET_Ps;
        read_mem_bytes(fd, addr, x_pos.bytes, 4);
        read_mem_bytes(fd, addr + 4, y_pos.bytes, 4);
        if (is_div_by(x_pos.float32, 0.000250) || is_div_by(y_pos.float32, 0.000250)) {
          continue;
        }
        printf("0x%lx %f %f\n", addr, x_pos.float32, y_pos.float32);


      }
      int k = 0;
//      while (k < SIZEARR(SAMPLE_PATTERN) && (SAMPLE_PATTERN[k] == -1 || SAMPLE_PATTERN[k] == (uint8_t)bytes[j + k])) {
//        k++;
//      }
//      if (k > 100) {
//        printf("%d\n", k);
//      }
//      if (k == SIZEARR(SAMPLE_PATTERN)) {
//        int first_byte = j + OFFSET;
//        union word32 x_pos;
//        union word32 y_pos;
//        union word32 z_pos;
//        union word32 ang1;
//        union word32 ang2;
//        uintptr_t addr = desc->start + first_byte;
//        for (;;) {
//          read_mem_bytes(fd, addr, x_pos.bytes, 4);
//          read_mem_bytes(fd, addr + 4, y_pos.bytes, 4);
//          read_mem_bytes(fd, addr + 8, z_pos.bytes, 4);
//          read_mem_bytes(fd, addr + 12, ang1.bytes, 4);
//          read_mem_bytes(fd, addr + 16, ang2.bytes, 4);
//          printf("%d %ld %f [%f %f %f %f %f]\n", i, desc->size, (double)first_byte / (double)desc->size, x_pos.float32,
//            y_pos.float32, z_pos.float32, ang1.float32, ang2.float32);
////          usleep(250 * 1000);dd
//          break;
//        }
//      }
    }
    free_mem(blocks[i]);
  }
}
